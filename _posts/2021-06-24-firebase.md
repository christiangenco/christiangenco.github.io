---
title: "Firebase"
image:
image_small:
excerpt: ""
---

# Firestore

## Batch writes

https://googleapis.dev/nodejs/firestore/latest/Firestore.html#bulkWriter

## Recursive deletes (delete a doc and its subcollections)

Only works on the backend:

```js
await firestore.recursiveDelete(docRef);
```

# Google Cloud Storage

# Firebase Cloud Functions

## Set timeout and memory allocation

```js
exports.doSomething = functions
  .runWith({
    timeoutSeconds: 9 * 60,
    memory: "1GB",
  })
  .firestore.document("collection/{docId}")
  .onCreate(doSomething);
```

Available options for memory (and accompanying CPU speed) are:

- 128MB — 200MHz
- 256MB — 400MHz
- 512MB — 800MHz
- 1GB — 1.4 GHz
- 2GB — 2.4 GHz
- 4GB — 4.8 GHz
- 8GB — 4.8 GHz

Source: https://firebase.google.com/docs/functions/manage-functions#set_timeout_and_memory_allocation

## Environment Variables

Instead of the old way of adding variables to `functions.config()`, add environment variables to `functions/.env` and check them into version control:

```
DROPBOX_KEY="foobarbaz"
```

Environment variables are synced with firebase when you deploy your firebase cloud functions with `firebase deploy --only functions`.

## Secrets

Set secrets with `firebase functions:secrets:set SECRET_NAME`. Destroy them with `functions:secrets:destroy SECRET_NAME`.

Access secrets in your functions as regular environment variables: `process.env.SECRET_NAME`

Make sure to explicitly whitelist the secret name for each function that uses it:

```js
exports.myFunction = functions
  .runWith({
    secrets: ["SECRET_NAME"],
  })
  .https.onRequest(myFunction);
```

## Remove cold start delay

To remove the cold start delay on cloud functions you need an instance running all the time:

```js
exports.foo = functions.runWith({ minInstances: 1 }).https.onRequest(foo);
```

You'll always have an instance running which based on [the google cloud pricing](https://cloud.google.com/functions/pricing) will cost no more than:

- 128MB — 200MHz: `0.000000231 * 10 * 60 * 60 * 24 * 30 =` $5.98/month
- 256MB — 400MHz: `0.000000463 * 10 * 60 * 60 * 24 * 30 =` $12.00/month
- 512MB — 800MHz: `0.000000925 * 10 * 60 * 60 * 24 * 30 =` $23.98/month
- 1GB — 1.40 GHz: `0.000001650 * 10 * 60 * 60 * 24 * 30 =` $42.76/month
- 2GB — 2.40 GHz: `0.000002900 * 10 * 60 * 60 * 24 * 30 =` $75.16/month
- 4GB — 4.80 GHz: `0.000005800 * 10 * 60 * 60 * 24 * 30 =` $150.33/month
- 8GB — 4.80 GHz: `0.000006800 * 10 * 60 * 60 * 24 * 30 =` $176.25/month

There are some free tier and sustained use discounts I don't totally understand.

Note that [functions running in some regions are cheaper than others](https://cloud.google.com/functions/docs/locations#tier_1_pricing). `us-central1` is one of the cheaper Tier 1 regions.

# Deploying

## `Functions deploy had errors with the following functions`

Try:

- checking the output of `firebase --debug deploy --only functions`
- checking the output of `firebase functions:log`
- deleting the `us.artifacts.[Project ID].appspot.com` bucket in the [Cloud Storage page on Google Cloud Platform](https://console.cloud.google.com/storage/browser).

Sources:

- [Cloud Functions not deploying: Build fails #795](https://github.com/firebase/firebase-functions/issues/795)
