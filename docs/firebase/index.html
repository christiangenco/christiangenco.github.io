<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link href="/css/style-081a.css
" rel="stylesheet" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    
    <!-- Primary Meta Tags -->
    <title>Firebase</title>
    <meta name="title" content="Firebase">
    <meta name="description" content="">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://christian.gen.co/firebase">
    <meta property="og:title" content="Firebase">
    <meta property="og:description" content="">
    <meta property="og:image" content="null">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://christian.gen.co/firebase">
    <meta property="twitter:title" content="Firebase">
    <meta property="twitter:description" content="">
    <meta property="twitter:image" content="null">
  

    <!-- Thanks https://realfavicongenerator.net/ :D -->
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicons/favicon-16x16.png">
    <link rel="manifest" href="/images/favicons/site.webmanifest">
    <link rel="mask-icon" href="/images/favicons/safari-pinned-tab.svg" color="#b91c1c">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="#b91c1c">
    <meta name="msapplication-config" content="/images/favicons/browserconfig.xml">
    <meta name="theme-color" content="#b91c1c">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.4.1/highlight.min.js"></script>
    <script>
      hljs.initHighlightingOnLoad();
    </script>
  </head>
  <body class="dark:bg-gray-900">
    <div class="container mx-auto px-4">
      <header
        class="border-b-4 border-red-700 font-mono my-4 md:flex items-center justify-between dark:text-white"
        style="border-bottom-right-radius: 225px 8px"
      >
        <h1 class="font-bold text-xl">
          <a href="/" class="hover:bg-gray-50 dark:hover:bg-gray-800 rounded"
            >Christian Genco</a
          >
        </h1>
        <nav class="text-xs sm:text-base">
          <a
            href="/videos"
            class="hover:bg-gray-50 dark:hover:bg-gray-800 rounded"
            >Videos</a
          >
          <a
            href="/articles"
            class="ml-4 hover:bg-gray-50 dark:hover:bg-gray-800 rounded"
            >Articles</a
          >
          <a
            href="/projects"
            class="ml-4 hover:bg-gray-50 dark:hover:bg-gray-800 rounded"
            >Projects
          </a>
          <a
            href="/notes"
            class="ml-4 hover:bg-gray-50 dark:hover:bg-gray-800 rounded"
            >Notes
          </a>
          <a
            href="/newsletter"
            class="ml-4 hover:bg-gray-50 dark:hover:bg-gray-800 rounded"
            >Newsletter</a
          >
        </nav>
      </header>
    </div>

    <main class="container mx-auto px-4">
      <h1
        class="font-mono-caps text-4xl md:text-6xl mb-6 mt-8 md:mb-10 md:mt-12 dark:text-white"
      >
        Firebase
      </h1>
      <article class="prose lg:prose-xl dark-mode:prose-dark">
        
      <h1 id="firestore">
        Firestore
        <a href="#firestore" class="anchor">#</a>
      </h1>
    
      <h2 id="batch-writes">
        Batch writes
        <a href="#batch-writes" class="anchor">#</a>
      </h2>
    <p><a href="https://googleapis.dev/nodejs/firestore/latest/Firestore.html#bulkWriter">https://googleapis.dev/nodejs/firestore/latest/Firestore.html#bulkWriter</a></p>

      <h2 id="recursive-deletes-delete-a-doc-and-its-subcollections-">
        Recursive deletes (delete a doc and its subcollections)
        <a href="#recursive-deletes-delete-a-doc-and-its-subcollections-" class="anchor">#</a>
      </h2>
    <p>Only works on the backend:</p>
<pre><code class="language-js">await firestore.recursiveDelete(docRef);</code></pre>

      <h1 id="google-cloud-storage">
        Google Cloud Storage
        <a href="#google-cloud-storage" class="anchor">#</a>
      </h1>
    <p>Frustratingly if you include a leading <code>/</code> in the <code>path</code> of your objects you upload Google Cloud Storage will create a new folder called <code>/</code> in your root directory.</p>
<p>Make sure you <strong>don&#39;t include a leading slash in your path</strong> or you&#39;ll be very confused for a long time when your files aren&#39;t actually where you think they are:</p>
<pre><code class="language-js">const { Storage } = require(&quot;@google-cloud/storage&quot;);
const gcs = new Storage();

const bucketName = &quot;project-id.appspot.com&quot;;
const bucket = gcs.bucket(bucketName);

const data = &quot;important data&quot;;
const badPath = `/no/wrong/bad/data.txt`;
const goodPath = `yes/correct/data.txt`;
await bucket.file(goodPath).save(data);</code></pre>

      <h1 id="firebase-cloud-functions">
        Firebase Cloud Functions
        <a href="#firebase-cloud-functions" class="anchor">#</a>
      </h1>
    
      <h2 id="set-timeout-and-memory-allocation">
        Set timeout and memory allocation
        <a href="#set-timeout-and-memory-allocation" class="anchor">#</a>
      </h2>
    <pre><code class="language-js">exports.doSomething = functions
  .runWith({
    timeoutSeconds: 9 * 60,
    memory: &quot;1GB&quot;,
  })
  .firestore.document(&quot;collection/{docId}&quot;)
  .onCreate(doSomething);</code></pre>
<p>Available options for memory (and accompanying CPU speed) are:</p>
<ul>
<li>128MB — 200MHz</li>
<li>256MB — 400MHz</li>
<li>512MB — 800MHz</li>
<li>1GB — 1.4 GHz</li>
<li>2GB — 2.4 GHz</li>
<li>4GB — 4.8 GHz</li>
<li>8GB — 4.8 GHz</li>
</ul>
<p>Source: <a href="https://firebase.google.com/docs/functions/manage-functions#set_timeout_and_memory_allocation">https://firebase.google.com/docs/functions/manage-functions#set_timeout_and_memory_allocation</a></p>

      <h2 id="environment-variables">
        Environment Variables
        <a href="#environment-variables" class="anchor">#</a>
      </h2>
    <p>Instead of the old way of adding variables to <code>functions.config()</code>, add environment variables to <code>functions/.env</code> and check them into version control:</p>
<pre><code>DROPBOX_KEY=&quot;foobarbaz&quot;</code></pre>
<p>Environment variables are synced with firebase when you deploy your firebase cloud functions with <code>firebase deploy --only functions</code>.</p>

      <h2 id="secrets">
        Secrets
        <a href="#secrets" class="anchor">#</a>
      </h2>
    <p>Set secrets with <code>firebase functions:secrets:set SECRET_NAME</code>. Destroy them with <code>functions:secrets:destroy SECRET_NAME</code>.</p>
<p>Access secrets in your functions as regular environment variables: <code>process.env.SECRET_NAME</code></p>
<p>Make sure to explicitly whitelist the secret name for each function that uses it:</p>
<pre><code class="language-js">exports.myFunction = functions
  .runWith({
    secrets: [&quot;SECRET_NAME&quot;],
  })
  .https.onRequest(myFunction);</code></pre>

      <h2 id="remove-cold-start-delay">
        Remove cold start delay
        <a href="#remove-cold-start-delay" class="anchor">#</a>
      </h2>
    <p>To remove the cold start delay on cloud functions you need an instance running all the time:</p>
<pre><code class="language-js">exports.foo = functions.runWith({ minInstances: 1 }).https.onRequest(foo);</code></pre>
<p>You&#39;ll always have an instance running which based on <a href="https://cloud.google.com/functions/pricing">the google cloud pricing</a> will cost no more than:</p>
<ul>
<li>128MB — 200MHz: <code>0.000000231 * 10 * 60 * 60 * 24 * 30 =</code> $5.98/month</li>
<li>256MB — 400MHz: <code>0.000000463 * 10 * 60 * 60 * 24 * 30 =</code> $12.00/month</li>
<li>512MB — 800MHz: <code>0.000000925 * 10 * 60 * 60 * 24 * 30 =</code> $23.98/month</li>
<li>1GB — 1.40 GHz: <code>0.000001650 * 10 * 60 * 60 * 24 * 30 =</code> $42.76/month</li>
<li>2GB — 2.40 GHz: <code>0.000002900 * 10 * 60 * 60 * 24 * 30 =</code> $75.16/month</li>
<li>4GB — 4.80 GHz: <code>0.000005800 * 10 * 60 * 60 * 24 * 30 =</code> $150.33/month</li>
<li>8GB — 4.80 GHz: <code>0.000006800 * 10 * 60 * 60 * 24 * 30 =</code> $176.25/month</li>
</ul>
<p>There are some free tier and sustained use discounts I don&#39;t totally understand.</p>
<p>Note that <a href="https://cloud.google.com/functions/docs/locations#tier_1_pricing">functions running in some regions are cheaper than others</a>. <code>us-central1</code> is one of the cheaper Tier 1 regions.</p>

      <h1 id="deploying">
        Deploying
        <a href="#deploying" class="anchor">#</a>
      </h1>
    
      <h2 id="-code-functions-deploy-had-errors-with-the-following-functions-code-">
        <code>Functions deploy had errors with the following functions</code>
        <a href="#-code-functions-deploy-had-errors-with-the-following-functions-code-" class="anchor">#</a>
      </h2>
    <p>Try:</p>
<ul>
<li>checking the output of <code>firebase --debug deploy --only functions</code></li>
<li>checking the output of <code>firebase functions:log</code></li>
<li>deleting the <code>us.artifacts.[Project ID].appspot.com</code> bucket in the <a href="https://console.cloud.google.com/storage/browser">Cloud Storage page on Google Cloud Platform</a>.</li>
</ul>
<p>Sources:</p>
<ul>
<li><a href="https://github.com/firebase/firebase-functions/issues/795">Cloud Functions not deploying: Build fails #795</a></li>
</ul>

      </article>
    </main>

    <div
      class="bg-gray-100 dark:bg-gray-800 dark:text-white border-t border-gray-300 dark:border-gray-700 mt-6"
    >
      <div class="container mx-auto px-4">
        <footer
          class="py-4 font-mono text-center md:text-left flex justify-items-start"
        >
          <img
            src="/images/profile.square.small.jpg"
            alt="Christian Genco profile photo"
            class="rounded-full w-16 h-16 block mx-auto md:inline flex-grow-0"
          />
          <div class="flex-grow ml-2 flex items-center flex-wrap">
            <a href="/articles" class="hover:underline">All Articles</a>
            <span class="text-red-700 mx-2">&#8226;</span>
            <a href="/notes" class="hover:underline">All Notes</a>
            <span class="text-red-700 mx-2">&#8226;</span>
            <a href="/projects" class="hover:underline">Projects</a>
            <span class="text-red-700 mx-2">&#8226;</span>
            <a href="https://twitter.com/cgenco" class="hover:underline"
              target="_blank">Twitter</a
            >
            <span class="text-red-700 mx-2">&#8226;</span>
            <a href="https://youtube.com/cgenco" class="hover:underline"
              target="_blank">YouTube</a
            >
            <span class="text-red-700 mx-2">&#8226;</span>
            <a href="https://facebook.com/cgenco" class="hover:underline"
              target="_blank">Facebook</a
            >
            <span class="text-red-700 mx-2">&#8226;</span>
            <a href="https://instagram.com/cgenco" class="hover:underline"
              target="_blank">Instagram</a
            >
            <span class="text-red-700 mx-2">&#8226;</span>
            <a href="https://github.com/christiangenco" class="hover:underline"
              target="_blank">GitHub</a
            >
            <span class="text-red-700 mx-2">&#8226;</span>
            <a href="http://www.linkedin.com/in/cgenco" class="hover:underline"
              target="_blank">LinkedIn</a
            >
            <span class="text-red-700 mx-2">&#8226;</span>
            <a href="mailto:christian@gen.co" class="hover:underline">Email</a>
            <span class="text-red-700 mx-2">&#8226;</span>
            <a href="/newsletter" class="hover:underline">Newsletter</a>
            <!-- RSS -->
          </div>
        </footer>
      </div>
    </div>
  </body>
</html>
